// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.24/esri/copyright.txt for details.
//>>built
define("esri/arcgis/utils","require dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/Deferred dojo/_base/json dojo/_base/url dojo/on dojo/DeferredList dojo/dom-construct dojo/sniff dojox/gfx/_base ../kernel ../config ../Color ../lang ../request ../SpatialReference ../map ../urlUtils ../geometry/ScreenPoint ../geometry/Extent ../geometry/webMercatorUtils ../symbols/jsonUtils ../renderers/jsonUtils ../dijit/PopupTemplate ../dijit/Popup ../tasks/query ../tasks/GeometryService ../layers/ArcGISTiledMapServiceLayer ../layers/FeatureLayer dojo/i18n!../nls/jsapi".split(" "),
function(K,n,k,w,u,L,ab,V,F,bb,rb,la,C,M,cb,l,D,E,db,W,ma,G,eb,H,J,X,fb,gb,hb,ib,x,Y){function I(a){return D({url:r.arcgisUrl+"/"+a.itemId+"/data",content:{f:"json"},callbackParamName:"callback"},{disableIdentityLookup:!0,_preLookup:!0})}function Z(a,e){var c={f:"json"};e&&(c.token=e);return D({url:a,content:c,callbackParamName:"callback"},{disableIdentityLookup:!0})}function aa(a){!a.layerDefinition||a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.labelingInfo||(a.showLabels=!1);a.itemProperties.layerDefinition&&
(a.layerDefinition?(a.layerDefinition.drawingInfo||(a.layerDefinition.drawingInfo=a.itemProperties.layerDefinition.drawingInfo),l.isDefined(a.layerDefinition.definitionExpression)||(a.layerDefinition.definitionExpression=a.itemProperties.layerDefinition.definitionExpression),l.isDefined(a.layerDefinition.minScale)||(a.layerDefinition.minScale=a.itemProperties.layerDefinition.minScale),l.isDefined(a.layerDefinition.maxScale)||(a.layerDefinition.maxScale=a.itemProperties.layerDefinition.maxScale)):
a.layerDefinition=a.itemProperties.layerDefinition);!a.itemProperties.popupInfo||a.popupInfo||a.disablePopup||(a.popupInfo=a.itemProperties.popupInfo);l.isDefined(a.itemProperties.showLabels)&&!l.isDefined(a.showLabels)&&(a.showLabels=a.itemProperties.showLabels);l.isDefined(a.itemProperties.showLegend)&&!l.isDefined(a.showLegend)&&(a.showLegend=a.itemProperties.showLegend);l.isDefined(a.itemProperties.refreshInterval)&&!l.isDefined(a.refreshInterval)&&(a.refreshInterval=a.itemProperties.refreshInterval)}
function na(a){aa(a);a.itemProperties.layerDefinition&&a.layerDefinition&&(!l.isDefined(a.layerDefinition.maximumTrackPoints)&&l.isDefined(a.itemProperties.layerDefinition.maximumTrackPoints)&&(a.layerDefinition.maximumTrackPoints=a.itemProperties.layerDefinition.maximumTrackPoints),!a.layerDefinition.definitionGeometry&&a.itemProperties.layerDefinition.definitionGeometry&&(a.layerDefinition.definitionGeometry=a.itemProperties.layerDefinition.definitionGeometry));a.itemProperties.purgeOptions&&!a.purgeOptions&&
(a.purgeOptions=a.itemProperties.purgeOptions)}function N(a,e){var c=new u,b=a.itemData,d=[],g=[];k.forEach(b.operationalLayers,function(a){if(a.itemId&&!a.type){var b=a.url.toLowerCase();-1<b.indexOf("/featureserver")||-1<b.indexOf("/mapserver/")?(g.push(a),d.push(I(a))):-1<b.indexOf("/mapserver")&&-1===b.indexOf("/mapserver/")&&(!a.layers||!l.isDefined(a.minScale)&&!l.isDefined(a.maxScale))?(g.push(a),d.push(I(a))):-1<b.indexOf("/imageserver")&&!l.isDefined(a.minScale)&&!l.isDefined(a.maxScale)?
(g.push(a),d.push(I(a))):-1<b.indexOf("/streamserver")&&(g.push(a),d.push(I(a)))}});b.baseMap&&b.baseMap.baseMapLayers&&k.forEach(b.baseMap.baseMapLayers,function(a){a.itemId&&"VectorTileLayer"!==a.layerType&&(g.push(a),d.push(I(a)))});if(0<d.length){var f={};(new F(d)).addCallback(function(b){k.forEach(g,function(a,d){var c=b[d][1];if(c&&!(c instanceof Error)&&(f[a.itemId]=c,!a.type)){var g=a.url.toLowerCase();(-1<g.indexOf("/featureserver")||-1<g.indexOf("/mapserver/"))&&c.layers?k.forEach(c.layers,
function(b){var c="/featureserver/"+b.id;(c=g.match(c+"$")==c)||(c="/mapserver/"+b.id,c=g.match(c+"$")==c);c&&(a.itemProperties=b,aa(a))}):-1<g.indexOf("/streamserver")?(a.itemProperties=c,na(a)):-1<g.indexOf("/mapserver")?(c.layers&&!a.layers&&(a.layers=c.layers),l.isDefined(c.minScale)&&!l.isDefined(a.minScale)&&(a.minScale=c.minScale),l.isDefined(c.maxScale)&&!l.isDefined(a.maxScale)&&(a.maxScale=c.maxScale),l.isDefined(c.refreshInterval)&&!l.isDefined(a.refreshInterval)&&(a.refreshInterval=c.refreshInterval),
c.visibleLayers&&!a.visibleLayers&&(a.visibleLayers=c.visibleLayers)):-1<g.indexOf("/imageserver")&&(l.isDefined(c.minScale)&&!l.isDefined(a.minScale)&&(a.minScale=c.minScale),l.isDefined(c.maxScale)&&!l.isDefined(a.maxScale)&&(a.maxScale=c.maxScale),l.isDefined(c.refreshInterval)&&!l.isDefined(a.refreshInterval)&&(a.refreshInterval=c.refreshInterval),!c.popupInfo||a.popupInfo||a.disablePopup||(a.popupInfo=c.popupInfo),c.renderingRule&&!a.renderingRule&&(a.renderingRule=c.renderingRule,c.renderingRule.functionName&&
(a.renderingRule.rasterFunction=c.renderingRule.functionName)),c.bandIds&&!a.bandIds&&(a.bandIds=c.bandIds),c.mosaicRule&&!a.mosaicRule&&(a.mosaicRule=c.mosaicRule),c.format&&!a.format&&(a.format=c.format),l.isDefined(c.compressionQuality)&&!l.isDefined(a.compressionQuality)&&(a.compressionQuality=c.compressionQuality),!c.layerDefinition||!c.layerDefinition.definitionExpression||l.isDefined(a.layerDefinition)&&l.isDefined(a.layerDefinition.definitionExpression)||(a.layerDefinition=a.layerDefinition||
{},a.layerDefinition.definitionExpression=c.layerDefinition.definitionExpression))}});a.relatedItemsData=f;c.callback(a)})}else c.callback(a);return c}function jb(a,e){var c=new u,b=a.itemData,d=b.baseMap.baseMapLayers[0];if("BingMapsAerial"===d.type||"BingMapsRoad"===d.type||"BingMapsHybrid"===d.type)if(d.portalUrl&&C.id)delete e.bingMapsKey,C.id.checkSignInStatus(W.urlToObject(r.arcgisUrl).path).then(n.hitch(null,function(a,b,c,g,e){Z(d.portalUrl,e.token).then(n.hitch(null,ba,a,b,c,g),n.hitch(null,
O,a,b,c,g))},a,e,b,c),n.hitch(null,function(a,b,c,g,e){Z(d.portalUrl).then(n.hitch(null,ba,a,b,c,g),n.hitch(null,O,a,b,c,g))},a,e,b,c));else if(e.bingMapsKey){var g=new z({bingMapsKey:e.bingMapsKey,mapStyle:z.MAP_STYLE_AERIAL});w.connect(g,"onLoad",n.hitch(this,function(){c.callback([a,e])}));w.connect(g,"onError",function(f){delete e.bingMapsKey;a.itemData=P(b);d=a.itemData.baseMap.baseMapLayers[0];d.errors=[];d.errors.push({message:"The owner of the application has not provided a valid Bing Key for the Bing Map it includes. Switching to Esri layers."});
c.callback([a,e])})}else a.itemData=P(b),d=a.itemData.baseMap.baseMapLayers[0],d.errors=[],d.errors.push({message:"The owner of the application has not provided a Bing Key for the Bing Map it includes. Switching to Esri layers."}),c.callback([a,e]);else c.callback([a,e]);return c}function kb(a){var e=new u,c,b;a=a.itemData;var d=a.baseMap&&a.baseMap.baseMapLayers;if(Q&&!Q.supported())for(a=0;a<d.length;a++){var g=d[a];if(!g.isReference){"VectorTileLayer"===g.layerType&&(c=g.itemId,b=a);break}}c?ca(c,
!1).addBoth(function(a){var c=/^https?:\/\/basemaps(dev)?\.arcgis\.com\/arcgis\/rest\/services\/World_Basemap\/VectorTileServer/i;a&&a.item&&c.test(a.item.url)&&(d[b]={id:"FB_"+g.id,layerType:"ArcGISTiledMapServiceLayer",opacity:"opacity"in g?g.opacity:1,visibility:"visibility"in g?g.visibility:!0,url:"https://services.arcgisonline.com/arcgis/rest/services/World_Street_Map/MapServer"});e.resolve()}):e.resolve();return e}function ba(a,e,c,b,d){d.bingKey?(e.bingMapsKey=d.bingKey,d=new z({bingMapsKey:e.bingMapsKey,
mapStyle:z.MAP_STYLE_AERIAL}),w.connect(d,"onLoad",n.hitch(this,function(){b.callback([a,e])})),w.connect(d,"onError",function(d){delete e.bingMapsKey;a.itemData=P(c);d=a.itemData.baseMap.baseMapLayers[0];d.errors=[];d.errors.push({message:"The owner of the map has not provided a valid Bing Key for the Bing Map it includes. Switching to Esri layers."});b.callback([a,e])})):O(a,e,c,b)}function O(a,e,c,b){delete e.bingMapsKey;a.itemData=P(c);c=a.itemData.baseMap.baseMapLayers[0];c.errors=[];c.errors.push({message:"The owner of the map has not provided a Bing Key for the Bing Map it includes. Switching to Esri layers."});
b.callback([a,e])}function P(a){a.baseMap="BingMapsAerial"===a.baseMap.baseMapLayers[0].type?{title:"Imagery",baseMapLayers:[{id:"World_Imagery_2017",visibility:!0,opacity:1,url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"}]}:"BingMapsRoad"===a.baseMap.baseMapLayers[0].type?{title:"Streets",baseMapLayers:[{id:"World_Street_Map_8421",opacity:1,visibility:!0,url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer"}]}:{title:"Imagery with Labels",
baseMapLayers:[{id:"World_Imagery_6611",opacity:1,visibility:!0,url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"},{id:"World_Boundaries_and_Places_1145",isReference:!0,opacity:1,visibility:!0,url:"https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer"}]};return a}function da(a,e,c,b){var d=a.dynamicLayerInfos||a.layerInfos,g=e.layers;if(g&&d)if(b.usePopupManager){var f;k.forEach(d,function(a){var b=a.id;if(!a.subLayerIds)for(a=
0;a<g.length;a++){var d=g[a];if(d.id===b&&d.popupInfo){f||(f={});f[b]={infoTemplate:new c(d.popupInfo),layerUrl:d.layerUrl};break}}});f&&a.setInfoTemplates(f)}else{var h=[],m=[],q=[],p=[],t=[],v=[];k.forEach(d,function(b){var c=b.id;if(!b.subLayerIds&&-1!==k.indexOf(a.visibleLayers,c))for(b=0;b<g.length;b++){var d=g[b];if(d.id===c){m.push(c);h.push(d.popupInfo);q.push(d.layerUrl||"");d.layerDefinition&&d.layerDefinition.definitionExpression?p.push(d.layerDefinition.definitionExpression):p.push("");
t.push(l.isDefined(d.minScale)?d.minScale:null);v.push(l.isDefined(d.maxScale)?d.maxScale:null);break}}});h.length&&(a.__popups=h,a.__popupIds=m,a.__popupUrls=q,a.__popupWhereClauses=p,a.__popupMinScales=t,a.__popupMaxScales=v,a.__resourceInfo=e.resourceInfo)}}function oa(a){if(!a)return!1;var e=(new ab(r.arcgisUrl)).authority;return-1!==a.indexOf(".arcgis.com/")||-1!==a.indexOf(e)}function pa(a){return a?-1!==a.indexOf("/services.arcgisonline.com/")||-1!==a.indexOf("/server.arcgisonline.com/"):!1}
function B(a){"https:"===location.protocol&&(oa(a)||pa(a))&&(a=a.replace("http:","https:"));return a}function ea(a,e,c){var b=[],d;a.displayLevels||(b=k.map(a.resourceInfo.tileInfo.lods,function(a){return a.level}));a.exclusionAreas&&(d=n.clone(a.exclusionAreas),d=k.map(d,function(a){a.geometry=new G(a.geometry);return a}));b=new ib(B(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,displayLevels:a.displayLevels||b,id:a.id,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval,
exclusionAreas:d});c.ignorePopups||da(b,a,e,c);return b}function fa(a,e){if(!a||!e||0===e.length)return[];var c=","+e+",",b=[],d,g=",";for(d=0;d<a.length;d++)if(null!==a[d].subLayerIds){if(-1===c.indexOf(","+a[d].id+",")||-1<g.indexOf(","+a[d].id+","))g+=a[d].subLayerIds.toString()+","}else-1<c.indexOf(","+a[d].id+",")&&-1===g.indexOf(","+a[d].id+",")&&b.push(a[d].id);return b}function qa(a,e,c){var b=new ra;b.format="png24";a.resourceInfo&&a.resourceInfo.supportedImageFormatTypes&&-1<a.resourceInfo.supportedImageFormatTypes.indexOf("PNG32")&&
(b.format="png32");var b=new sa(B(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,imageParameters:b,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval}),d=a.visibleLayers;if(!a.visibleLayers){var g="";k.forEach(b.layerInfos,function(a){a.defaultVisibility&&(g+=(0<g.length?",":"")+a.id)});d=g}if(a.layers&&0<a.layers.length){var f=[],h=[],m,q=[],p,l;k.forEach(a.layers,function(b){var c=b.layerDefinition;c&&c.definitionExpression&&(f[b.id]=c.definitionExpression);
if(c&&c.source){m=null;l=c.source;if("mapLayer"===l.type){var d=k.filter(a.resourceInfo.layers,function(a){return a.id===l.mapLayerId});d.length&&(m=n.mixin(d[0],b))}else m=n.mixin({},b);m&&(m.source=l,delete m.popupInfo,m=new ta(m),a.visibleLayers&&(d="string"==typeof a.visibleLayers?a.visibleLayers.split(","):a.visibleLayers,-1<k.indexOf(d,b.id)?m.defaultVisibility=!0:m.defaultVisibility=!1),h.push(m))}c&&null!=c.transparency&&(d=c.drawingInfo||{},null==d.transparency&&(d.transparency=c.transparency,
c.drawingInfo=d));c&&c.source&&c.drawingInfo&&(p=new ua(c.drawingInfo),q[b.id]=p)},this);0<f.length&&b.setLayerDefinitions(f);0<h.length?(b.setDynamicLayerInfos(h,!0),0<q.length&&b.setLayerDrawingOptions(q,!0)):(d=fa(b.layerInfos,d),b.setVisibleLayers(d))}else d=fa(b.layerInfos,d),b.setVisibleLayers(d);c.ignorePopups||da(b,a,e,c);return b}function lb(a,e,c){var b=new va;b.bandIds=a.bandIds;null!=a.format&&(b.format=a.format,null!=a.compressionQuality&&(b.compressionQuality=a.compressionQuality));
if(a.renderingRule&&a.renderingRule.rasterFunction){var d=new wa(a.renderingRule);b.renderingRule=d}a.mosaicRule&&(d=new xa(a.mosaicRule),b.mosaicRule=d);l.isDefined(a.noData)&&(b.noData=a.noData);l.isDefined(a.noDataInterpretation)&&(b.noDataInterpretation=a.noDataInterpretation);l.isDefined(a.interpolation)&&(b.interpolation=a.interpolation);d=a.layerType?"ArcGISImageServiceVectorLayer"===a.layerType:!1;l.isDefined(a.layerType)||(d=a.resourceInfo.hasMultidimensions&&("esriImageServiceDataTypeVector-UV"===
a.resourceInfo.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===a.resourceInfo.serviceDataType));b={resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,imageServiceParameters:b,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval};b=d?new ya(B(a.url),b):new za(B(a.url),b);a.layerDefinition&&(a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.renderer&&(d=J.fromJson(a.layerDefinition.drawingInfo.renderer),b.setRenderer(d)),a.layerDefinition.definitionExpression&&
b.setDefinitionExpression(a.layerDefinition.definitionExpression,!0));!c.ignorePopups&&a.popupInfo&&b.setInfoTemplate(new e(a.popupInfo));return b}function ga(a,e,c){var b=[102113,102100,3857],d=c||new E(e[0].layerObject.fullExtent.spatialReference),g=new E(a.resourceInfo.fullExtent.spatialReference);return d.wkt==g.wkt&&(d.wkid==g.wkid||l.isDefined(d.latestWkid)&&d.latestWkid==g.wkid||l.isDefined(g.latestWkid)&&d.wkid==g.latestWkid||l.isDefined(d.latestWkid)&&d.latestWkid==g.latestWkid)||d.wkid&&
g.wkid&&k.some(b,function(a){return a===g.wkid})&&k.some(b,function(a){return a===d.wkid})?!0:!1}function ha(a,e,c){if(!e[0].layerObject.tileInfo)return!1;a=a.resourceInfo.tileInfo;e=e[0].layerObject.tileInfo;c=c.width>c.height?c.width:c.height;for(var b=!1,d=!1,g=0;g<a.lods.length;g++){for(var f=a.lods[g].scale/a.dpi,h=0;h<e.lods.length;h++){var m=e.lods[h].scale/e.dpi;if(Math.abs(m-f)/m<1/c)if(b){d=!0;break}else b=!0}if(d)break}return d||b&&(1===a.lods.length||1===e.lods.length)?!0:!1}function Aa(a,
e,c,b,d,g){var f,h,m=c._clazz;if("OpenStreetMap"===a.type)f=new Ba({id:a.id,opacity:a.opacity,visible:null!==a.visibility&&void 0!==a.visibility?a.visibility:!0});else if("WFS"===a.type)b={customParameters:a.wfsInfo.customParameters,geometryType:a.layerDefinition.geometryType,id:a.id,labelingInfo:a.layerDefinition.drawingInfo.labelingInfo,maxFeatures:a.wfsInfo.maxFeatures,mode:a.mode,name:a.wfsInfo.name,showLabels:!0,swapXY:a.wfsInfo.swapXY,title:a.title,url:a.url,version:a.wfsInfo.version,visible:a.visibility,
wkid:a.layerDefinition.spatialReference.wkid},f=new Ca,f.fromJson(b,function(){l.isDefined(a.opacity)&&f.setOpacity(a.opacity);l.isDefined(a.visibility)&&f.setVisibility(a.visibility);(a.minScale||a.maxScale)&&f.setScaleRange(a.minScale,a.maxScale);f.renderer=J.fromJson(a.layerDefinition.drawingInfo.renderer);!c.ignorePopups&&a.popupInfo&&f.setInfoTemplate(new m(a.popupInfo));f.emit("fromJsonComplete")});else if("WMS"===a.type){var q=[],p=[];k.forEach(a.layers,function(a){p.push(new Da({name:a.name,
title:a.title,legendURL:a.legendURL,queryable:a.queryable,showPopup:a.showPopup}));q.push(a.name)},this);a.visibleLayers&&(q=a.visibleLayers);b=new G(a.extent[0][0],a.extent[0][1],a.extent[1][0],a.extent[1][1],new E({wkid:4326}));b={customLayerParameters:a.customLayerParameters,customParameters:a.customParameters,extent:b,layerInfos:p,version:a.version,maxWidth:a.maxWidth,maxHeight:a.maxHeight,featureInfoFormat:a.featureInfoFormat,getFeatureInfoURL:a.featureInfoUrl,getMapURL:a.mapUrl,spatialReferences:a.spatialReferences,
title:a.title,copyright:a.copyright,minScale:a.minScale||0,maxScale:a.maxScale||0,format:a.format};f=new Ea(a.url,{id:a.id,visibleLayers:q,format:"png",transparent:a.firstLayer?!1:!0,opacity:a.opacity,visible:null!==a.visibility?a.visibility:!0,resourceInfo:b,refreshInterval:a.refreshInterval});f.spatialReference.wkid=b.spatialReferences[0]}else if("KML"===a.type){h=a.url;if(C.id){var t=C.id.findCredential(W.urlToObject(r.arcgisUrl).path);t&&(e=r.arcgisUrl.substring(r.arcgisUrl.indexOf("//")+2,r.arcgisUrl.indexOf("/",
r.arcgisUrl.indexOf("//")+3)),d=e.split("."),d=d[d.length-2]+"."+d[d.length-1],g=h.indexOf(d),-1<g&&(h="https://"+e+h.substring(g+d.length),h+="?token\x3d"+t.token))}f=new Fa(h,{id:a.id,visible:null!==a.visibility?a.visibility:!0,outSR:b,refreshInterval:a.refreshInterval});w.connect(f,"onLoad",function(){(a.opacity||0===a.opacity)&&f.setOpacity(a.opacity);l.isDefined(a.minScale)&&l.isDefined(a.maxScale)&&f.setScaleRange(a.minScale,a.maxScale);a.visibleFolders&&k.forEach(f.folders,function(b){-1<k.indexOf(a.visibleFolders,
b.id)?f.setFolderVisibility(b,!0):f.setFolderVisibility(b,!1)},this)})}else if("WebTiledLayer"===a.type){if(f=new Ga(a.templateUrl,{id:a.id,visible:null!==a.visibility?a.visibility:!0,opacity:a.opacity,copyright:a.copyright,fullExtent:a.fullExtent&&new G(a.fullExtent),initialExtent:a.fullExtent&&new G(a.fullExtent),subDomains:a.subDomains,tileInfo:a.tileInfo?new Ha(a.tileInfo):null,refreshInterval:a.refreshInterval,wmtsInfo:a.wmtsInfo}),l.isDefined(a.minScale)||l.isDefined(a.maxScale))f.loaded?f.setScaleRange(a.minScale,
a.maxScale):w.connect(f,"onLoad",function(){f.setScaleRange(a.minScale,a.maxScale)})}else if("GeoRSS"===a.type)f=new Ia(a.url,{id:a.id,opacity:a.opacity,outSpatialReference:b,refreshInterval:a.refreshInterval}),w.connect(f,"onLoad",function(){!1===a.visibility&&f.hide();l.isDefined(a.minScale)&&l.isDefined(a.maxScale)&&f.setScaleRange(a.minScale,a.maxScale);var b=f.getFeatureLayers();k.forEach(b,function(c){a.pointSymbol&&"esriGeometryPoint"===c.geometryType?(c.renderer.symbol=H.fromJson(a.pointSymbol),
1===b.length&&(f.pointSymbol=H.fromJson(a.pointSymbol))):a.lineSymbol&&"esriGeometryPolyline"===c.geometryType?(c.renderer.symbol=H.fromJson(a.lineSymbol),1===b.length&&(f.polylineSymbol=H.fromJson(a.lineSymbol))):a.polygonSymbol&&"esriGeometryPolygon"===c.geometryType&&(c.renderer.symbol=H.fromJson(a.polygonSymbol),1===b.length&&(f.polygonSymbol=H.fromJson(a.polygonSymbol)))})});else if("CSV"==a.type&&a.url)b={layerDefinition:a.layerDefinition,columnDelimiter:a.columnDelimiter,id:a.id?a.id:null,
visible:null!==a.visibility?a.visibility:!0,opacity:a.opacity,refreshInterval:a.refreshInterval},a.locationInfo&&(b.latitudeFieldName=a.locationInfo.latitudeFieldName,b.longitudeFieldName=a.locationInfo.longitudeFieldName),c.ignorePopups||(b.infoTemplate=new X(a.popupInfo?a.popupInfo:Ja.generateDefaultPopupInfo(a))),f=new Ka(a.url,b);else if("VectorTileLayer"===a.layerType&&a.styleUrl)f=new Q(a.styleUrl,{id:a.id,minScale:a.minScale,maxScale:a.maxScale,opacity:a.opacity,visible:a.visibility});else if(a.layerDefinition&&
!a.url)b=L.fromJson(L.toJson(a)),delete b.id,delete b.opacity,delete b.visibility,f=new x(b,{id:a.id,opacity:a.opacity,visible:a.visibility,outFields:["*"],autoGeneralize:!0}),!c.ignorePopups&&b.popupInfo&&f.setInfoTemplate(new m(b.popupInfo)),La(f);else if("BingMapsAerial"===a.type||"BingMapsRoad"===a.type||"BingMapsHybrid"===a.type)c.bingMapsKey?(b=z.MAP_STYLE_AERIAL_WITH_LABELS,"BingMapsAerial"===a.type?b=z.MAP_STYLE_AERIAL:"BingMapsRoad"===a.type&&(b=z.MAP_STYLE_ROAD),f=new z({bingMapsKey:c.bingMapsKey,
mapStyle:b,opacity:a.opacity,id:a.id}),w.connect(f,"onError",n.hitch(this,function(a){a.errors=a.errors||[];a.errors.push({message:"This application does not have a valid Bing Key for the Bing layer that is included in this map. [type:"+a.type+"]"})},a))):(a.errors=a.errors||[],a.errors.push({message:"This application does not provide a Bing Key for the Bing layer that is included in this map. [type:"+a.type+"]"}));else if(a.resourceInfo&&a.resourceInfo.mapName)f=!0===a.resourceInfo.singleFusedMapCache&&
(a.baseMapLayer||ga(a,e,b)&&ha(a,d,g))?ea(a,m,c):qa(a,m,c);else if(a.resourceInfo&&a.resourceInfo.pixelSizeX)f=!0===a.resourceInfo.singleFusedMapCache&&(a.baseMapLayer||ga(a,e,b)&&ha(a,d,g))?ea(a,m,c):lb(a,m,c);else if(a.resourceInfo&&"Feature Layer"===a.resourceInfo.type){a.capabilities&&(a.resourceInfo.capabilities=a.capabilities);var v;!1===c.editable?v=!1:c.privileges&&-1===k.indexOf(c.privileges,"features:user:edit")&&C.id&&C.id.findCredential(a.url)&&(v=!1);f=new x(B(a.url),{resourceInfo:a.resourceInfo,
opacity:a.opacity,visible:a.visibility,id:a.id,mode:a.mode===x.MODE_SELECTION?x.MODE_SELECTION:x.MODE_AUTO,editable:v,outFields:["*"],autoGeneralize:!0,refreshInterval:a.refreshInterval});!c.ignorePopups&&a.popupInfo&&f.setInfoTemplate(new m(a.popupInfo));a.layerDefinition&&(a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.renderer&&(b=J.fromJson(a.layerDefinition.drawingInfo.renderer),b.isMaxInclusive=!0,f.setRenderer(b)),a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.labelingInfo&&
(b=k.map(a.layerDefinition.drawingInfo.labelingInfo,function(a){return new Ma(a)}),f.setLabelingInfo(b)),a.layerDefinition.definitionExpression&&f.setDefinitionExpression(a.layerDefinition.definitionExpression),l.isDefined(a.layerDefinition.minScale)&&f.setMinScale(a.layerDefinition.minScale),l.isDefined(a.layerDefinition.maxScale)&&f.setMaxScale(a.layerDefinition.maxScale));La(f)}else a.resourceInfo&&a.resourceInfo.streamUrls&&(b={resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,
id:a.id},a.layerDefinition&&(t=a.layerDefinition.drawingInfo,a.layerDefinition.definitionGeometry&&(h=h||{},h.geometry=a.layerDefinition.definitionGeometry),l.isDefined(a.layerDefinition.definitionExpression)&&(h=h||{},h.where=a.layerDefinition.definitionExpression),l.isDefined(a.layerDefinition.maximumTrackPoints)&&(b.maximumTrackPoints=a.layerDefinition.maximumTrackPoints)),h&&(b.filter=h),a.purgeOptions&&(b.purgeOptions=a.purgeOptions),f=new Na(B(a.url),b),t&&t.renderer&&(b=t.renderer,f.setRenderer(J.fromJson(b))),
!c.ignorePopups&&a.popupInfo&&f.setInfoTemplate(new m(a.popupInfo)),a.layerDefinition&&(l.isDefined(a.layerDefinition.minScale)&&f.setMinScale(a.layerDefinition.minScale),l.isDefined(a.layerDefinition.maxScale)&&f.setMaxScale(a.layerDefinition.maxScale)),V.once(f,"error",function(b){a.errors.push({message:"Error loading stream layer. Check websocket url"})}));f&&(f.arcgisProps={title:a.title},a.baseMapLayer&&(a.isReference?(f.attr("data-reference",!0),f._basemapGalleryLayerType="reference"):f._basemapGalleryLayerType=
"basemap"),f instanceof x&&a.layerDefinition&&a.layerDefinition.featureReduction&&"cluster"===a.layerDefinition.featureReduction.type&&(b=a.layerDefinition.featureReduction,b.clusterSize&&(b.clusterSize=la.pt2px(b.clusterSize)),b.clusterRadius&&(b.clusterRadius=la.pt2px(b.clusterRadius)),b.popupInfo&&(b.infoTemplate=new X(b.popupInfo),delete b.popupInfo),f.setFeatureReduction(b)));return f}function ia(a,e,c,b,d){k.forEach(a,function(f){f.layerObject=Aa(f,a,e,c,b,d)});var g=k.filter(a,function(a){return!a.isReference}),
f=k.filter(a,function(a){return!!a.isReference});return a=g.concat(f)}function ja(a){var e=null;a=a[0];a.url&&!a.type?a.resourceInfo.spatialReference&&(e=new E,a.resourceInfo.spatialReference.wkid&&(e.wkid=a.resourceInfo.spatialReference.wkid),a.resourceInfo.spatialReference.wkt&&(e.wkt=a.resourceInfo.spatialReference.wkt)):a.type&&(-1<a.type.indexOf("BingMaps")||"OpenStreetMap"==a.type?e=new E({wkid:102100}):"WMS"==a.type&&(e=new E({wkid:a.spatialReferences[0]})));return e}function Oa(a,e,c,b,d,
g,f,h){k.forEach(e,function(b){b.url&&!b.type&&(b.resourceInfo=a[b.deferredsPos][1],delete b.deferredsPos)});g=g||ja(e);e=ia(e,c,g,f,h);d.callback(e);return d}function La(a){!window.CanvasRenderingContext2D&&a.renderer&&"esri.renderer.HeatmapRenderer"===a.renderer.declaredClass&&a.setRenderer(J.fromJson({type:"simple",symbol:{color:[77,77,77,255],size:6,angle:0,xoffset:0,yoffset:0,type:"esriSMS",style:"esriSMSCircle",outline:{color:[255,255,255,255],width:.75,type:"esriSLS",style:"esriSLSSolid"}}}))}
function Pa(a,e){var c=B(a);return D({url:c,content:{f:"json"},callbackParamName:"callback",error:function(a,d){a.message=a.message?a.message+(" [url:"+c+"]"):"[url:"+c+"]";e.push(a);M.defaults.io.errorHandler(a,d)}})}function Qa(a){var e=r.arcgisUrl+"/"+a.itemId+"/data";return D({url:e,content:{f:"json"},callbackParamName:"callback",error:function(c,b){c.message=c.message?c.message+(" [url:"+e+"]"):"[url:"+e+"]";a.errors=a.errors||[];a.errors.push(c);M.defaults.io.errorHandler(c,b)}})}function Ra(a,
e,c){var b=new u;if(!(c.featureCollection&&c.featureCollection.layers||c.layers))return console.log("Invalid Feature Collection item data [item id: "+a.itemId+"]: ",c),a.errors=a.errors||[],a.errors.push({message:"Invalid Feature Collection item data. [item id: "+a.itemId+"]"}),b.errback(),b;c.layers&&(c.featureCollection={layers:c.layers},delete c.layers,l.isDefined(c.showLegend)&&(c.featureCollection.showLegend=c.showLegend,delete c.showLegend));Sa(a,c.featureCollection,e).then(function(d){c.featureCollection=
d;a.featureCollection&&a.featureCollection.layers?k.forEach(c.featureCollection.layers,function(b,c){var d=a.featureCollection.layers[c];d.popupInfo||d.layerDefinition?d.layerDefinition?(l.isDefined(d.layerDefinition.minScale)&&l.isDefined(d.layerDefinition.maxScale)&&(d.layerDefinition.minScale!==b.layerDefinition.minScale||d.layerDefinition.maxScale!==b.layerDefinition.maxScale)&&(delete b.layerDefinition.minScale,delete b.layerDefinition.maxScale),d.layerDefinition.drawingInfo&&L.toJson(d.layerDefinition.drawingInfo)!==
L.toJson(b.layerDefinition.drawingInfo)&&delete b.layerDefinition.drawingInfo,d.layerDefinition.showLegend!==b.layerDefinition.showLegend&&delete b.layerDefinition.showLegend,d.layerDefinition=n.mixin(d.layerDefinition,b.layerDefinition)):d.layerDefinition=b.layerDefinition:(d.popupInfo=b.popupInfo,d.layerDefinition=b.layerDefinition);d.featureSet=b.featureSet;d.nextObjectId=b.nextObjectId}):(a.featureCollection=a.featureCollection||{},a.featureCollection=n.mixin(a.featureCollection,c.featureCollection));
b.callback(a)});return b}function Sa(a,e,c){var b=new u;K(["./csv"],function(d){var g=[];k.forEach(e.layers,function(a){a.featureSet&&a.featureSet.features&&a.featureSet.features.length&&a.featureSet.features[0].geometry&&a.featureSet.features[0].geometry.spatialReference&&(a.deferredsPos=g.length,g.push(d.projectFeatureCollection(a,c,a.featureSet.features[0].geometry.spatialReference)))});(new F(g)).addCallback(function(){k.forEach(e.layers,function(b){l.isDefined(b.deferredsPos)&&(g[b.deferredsPos].results&&
g[b.deferredsPos].results.length?b=g[b.deferredsPos].results[0]:(console.log("Errors projecting feature collection. ["+a.title+" - "+b.layerDefinition.name+"]"),b.errors=b.errors||[],b.errors.push({message:"Errors projecting feature collection. ["+a.title+" - "+b.layerDefinition.name+"]"})),delete b.deferredsPos)});b.callback(e)})});return b}function R(a,e,c,b,d){var g=new u,f=new u,h=[],m;k.forEach(a.operationalLayers,function(a){a.itemId&&"Feature Collection"==a.type&&h.push(Qa(a).then(n.hitch(null,
Ra,a,c)))});0===h.length?Ta(a,e,c,b,f,d):(m=new F(h),m.addCallback(function(g){Ta(a,e,c,b,f,d)}));f.then(function(a){h=[];k.forEach(a,function(a){var b;a=a.layerObject;a instanceof x&&!a.loaded&&!a.loadError?(b=new u,V.once(a,"load, error",function(){b.callback(a)}),h.push(b)):a&&"esri.layers.WFSLayer"===a.declaredClass&&!a.loadError&&(b=new u,V.once(a,"fromJsonComplete, error",function(c){b.callback(a)}),h.push(b))});if(h.length){var b=new u;m=new F(h);m.addCallback(function(){b.callback(a)});return b.promise}return a}).then(function(a){var b=
[];k.forEach(a,function(a){var c=a.layerObject;c instanceof x?c.loaded&&c.labelingInfo&&(a.showLabels||c._collection)&&b.push(c):c&&"esri.layers.WFSLayer"===c.declaredClass&&c.loaded&&c.labelingInfo&&b.push(c)});b.length?K(["../layers/LabelLayer"],function(c){var d=new c;k.forEach(b,function(a){d.addFeatureLayer(a)});a.push({layerObject:d});g.callback(a)}):g.callback(a)});return g}function Ta(a,e,c,b,d,g){var f=[],h=[],m=[];k.forEach(a.operationalLayers,function(a,b){if(a.featureCollection&&a.featureCollection.layers){var c=
a.featureCollection.layers.length;k.forEach(a.featureCollection.layers,function(d,f){var e=!0;a.visibleLayers&&-1==k.indexOf(a.visibleLayers,f)&&(e=!1);d.visibility=a.visibility&&e;d.opacity=a.opacity;d.id=(a.id||"operational"+b)+"_"+f;a.title&&(d.title=1!==c&&d.layerDefinition.name&&a.title!==d.layerDefinition.name?a.title+" - "+d.layerDefinition.name:a.title);m.push(d)},this)}else m.push(a)});k.forEach(a.baseMap.baseMapLayers,function(a,b){a.baseMapLayer=!0;a.id=a.id||"base"+b;f.push(a)});k.forEach(m,
function(a,b){a.id=a.id||"operational"+b;f.push(a)});k.forEach(f,function(a){a.url&&!a.type&&(a.deferredsPos=h.length,a.errors=a.errors||[],h.push(Pa(a.url,a.errors)))});0===h.length?(c=c||ja(f),f=ia(f,e,c,b,g),d.callback(f)):(new F(h)).addCallback(function(a){Oa(a,f,e,h,d,c,b,g)});return d}function S(a,e,c,b){var d=a.minScale,g=a.maxScale;if(10.1>=c.version&&e)for(a=e.length-1;0<=a;a--){if(e[a].id==b)if(0==d&&0<e[a].minScale?d=e[a].minScale:0<d&&0==e[a].minScale?d=c.minScale:0<d&&0<e[a].minScale&&
(d=Math.min(d,e[a].minScale)),g=Math.max(c.maxScale||0,e[a].maxScale||0),c.setScaleRange(d,g),-1<e[a].parentLayerId)b=e[a].parentLayerId;else break}else 10.1<c.version&&(k.forEach(a.layerInfos,function(a){a.id==b&&(0==d&&0<a.minScale?d=a.minScale:0<d&&0==a.minScale||0<d&&0<a.minScale&&(d=Math.min(d,a.minScale)),g=Math.max(g||0,a.maxScale||0))}),c.setScaleRange(d,g))}function T(a,e,c,b){var d=a.url,g=a.__popupIds,f=a.__popupUrls,h=a.__popupWhereClauses,m=a.__popupMinScales,q=a.__popupMaxScales,p=a.__resourceInfo,
t=[];k.forEach(a.__popups,function(b,y){if(b){var v,n=[];k.forEach(b.fieldInfos,function(a){"shape"!==a.fieldName.toLowerCase()&&n.push(a.fieldName)});if(a.dynamicLayerInfos&&0<a.dynamicLayerInfos.length){var r=k.filter(a.dynamicLayerInfos,function(a){return g[y]==a.id})[0].source;v=new x(d+"/dynamicLayer",{id:a.id+"_"+g[y],source:r,outFields:n,mode:x.MODE_SELECTION,infoTemplate:b&&new c(b),drawMode:!1,visible:a.visible,autoGeneralize:!0});var u=function(b,c){0<h[b].length&&c.setDefinitionExpression(h[b]);
if(l.isDefined(m[b])||l.isDefined(q[b]))if(l.isDefined(a.minScale)||l.isDefined(a.maxScale)){var d=a.minScale,f=a.maxScale;0==d&&0<m[b]?d=m[b]:0<d&&0==m[b]||0<d&&0<m[b]&&(d=Math.min(d,m[b]));f=Math.max(f||0,q[b]||0);c.setScaleRange(d,f)}else c.setScaleRange(m[b],q[b]);else S(a,e||p.layers,c,g[b])};v.loaded?u(y,v):w.connect(v,"onLoad",function(a){u(y,v)})}else{var z=null,A=d+"/"+g[y];if(f[y].length)A=f[y];else if(e)for(r=0;r<e.length;r++)if(e[r].id===g[y]){z=e[r];break}v=new x(B(A),{id:a.id+"_"+g[y],
outFields:n,mode:x.MODE_SELECTION,infoTemplate:b&&new c(b),drawMode:!1,visible:a.visible,resourceInfo:z,autoGeneralize:!0});v.loaded?(0<h[y].length&&v.setDefinitionExpression(h[y]),S(a,e||p.layers,v,g[y])):w.connect(v,"onLoad",function(b){0<h[y].length&&v.setDefinitionExpression(h[y]);S(a,e||p.layers,b,g[y])})}t.push(v)}});0<t.length&&(w.connect(a,"onVisibilityChange",n.hitch(this,function(a,b){k.forEach(a,function(a){b?a.show():a.hide()})},t)),w.connect(b,"onLayerRemove",n.hitch(this,function(a,
c,d){a.id===d.id&&k.forEach(c,function(a){b.removeLayer(a)})},a,t)));delete a.__popups;delete a.__popupIds;delete a.__popupUrls;delete a.__popupWhereClauses;delete a.__popupMinScales;delete a.__popupMaxScales;delete a.__resourceInfo;return t}function Ua(a){return D({url:B(a.url+"/layers"),content:{f:"json"},callbackParamName:"callback",error:function(){}})}function Va(a,e,c){var b=[];k.forEach(a,function(a){var c=a.__popups;c&&1<c.length&&10<=a.version&&(a.__deferredsPos=b.length,b.push(Ua(a)))});
var d=[];0<b.length?(new F(b)).addCallback(function(b){k.forEach(a,function(a){a.__popups&&0<a.__popups.length&&(a.__deferredsPos||0===a.__deferredsPos?(d=d.concat(T(a,b[a.__deferredsPos][1].layers,c,e)),delete a.__deferredsPos):d=d.concat(T(a,null,c,e)))});e.addLayers(d)}):(k.forEach(a,function(a){a.__popups&&0<a.__popups.length&&(d=d.concat(T(a,null,c,e)))}),e.addLayers(d))}function Wa(a){k.forEach(a,function(a){var c=a.layer;c.toJson&&(a=c.toJson(),a.featureSet&&c.name&&-1<c.name.indexOf("Text")&&
k.forEach(a.featureSet.features,function(a,d){if(a.attributes.TEXT){var b=c.graphics[d];b.symbol.setText(a.attributes.TEXT);a.symbol.horizontalAlignment&&(b.symbol.align=a.symbol.horizontalAlignment);b.setSymbol(b.symbol);b.setAttributes(a.attributes)}},this))})}function Xa(a){var e=6;k.forEach(a,function(a){if(a=a.renderer)"esri.renderer.SimpleRenderer"===a.declaredClass?((a=a.symbol)&&a.xoffset&&(e=Math.max(e,Math.abs(a.xoffset))),a&&a.yoffset&&(e=Math.max(e,Math.abs(a.yoffset)))):"esri.renderer.UniqueValueRenderer"!==
a.declaredClass&&"esri.renderer.ClassBreaksRenderer"!==a.declaredClass||k.forEach(a.infos,function(a){(a=a.symbol)&&a.xoffset&&(e=Math.max(e,Math.abs(a.xoffset)));a&&a.yoffset&&(e=Math.max(e,Math.abs(a.yoffset)))})});return e}function ka(a){var e=this,c=e.infoWindow,b=a.graphic;if(e.loaded){c.hide();c.clearFeatures();var d=[];k.forEach(e.graphicsLayerIds,function(a){(a=e.getLayer(a))&&a instanceof x&&a.loaded&&a.visible&&(a.clearSelection(),a.infoTemplate&&!a.suspended&&d.push(a))});k.forEach(e.layerIds,
function(a){(a=e.getLayer(a))&&-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")&&a.loaded&&a.visible&&a.infoTemplate&&d.push(a)});b=b&&b.getInfoTemplate()?b:null;if(d.length||b){var g=Xa(d),f=a.screenPoint,h=e.toMap(new ma(f.x-g,f.y+g)),g=e.toMap(new ma(f.x+g,f.y-g)),m=new G(h.x,h.y,g.x,g.y,e.spatialReference),l=new gb;l.geometry=m;l.timeExtent=e.timeExtent;var p=!0,h=k.map(d,function(b){b=b&&b.isFeatureReductionActive&&b.isFeatureReductionActive()?b.getFeatureReductionLayer():b;var c;if(-1!==
b.declaredClass.indexOf("ArcGISImageServiceLayer"))l.geometry=a.mapPoint,p=!1,c=b.queryVisibleRasters(l,{rasterAttributeTableFieldPrefix:"Raster.",returnDomainValues:!0}),c.addCallback(function(){return b.getVisibleRasters()});else if("function"===typeof b.selectFeatures)c=b.selectFeatures(l),c.addCallback(function(){return b.getSelectedFeatures()});else{c=new u;var d=k.filter(b.graphics,function(a){return a&&a.visible&&m.intersects(a.geometry)});c.resolve(d)}return c});b&&(g=new u,g.callback([b]),
h.splice(0,0,g));if(!k.some(h,function(a){return-1===a.fired})){var t=b?1:0;k.forEach(d,function(a){t=-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")?t+a.getVisibleRasters().length:t+a.getSelectedFeatures().length});if(!t)return}c.setFeatures(h);c.show(a.mapPoint,{closestFirst:p})}}}function mb(a,e){var c=e.mapOptions||{},b;c.infoWindow||(b=new fb({visibleWhenEmpty:!1},bb.create("div")),c.infoWindow=b);l.isDefined(c.showInfoWindowOnClick)||e.usePopupManager||(c.showInfoWindowOnClick=!1);c=
new db(a,c);w.connect(c,"onLayersAddResult",Wa);return c}function A(a,e,c,b,d,g){var f,h,m,l;b.map?(f=b.map,h=b.clickEventHandle,m=b.clickEventListener,l=b.errors):(f=mb(b,d),d.ignorePopups||d.disableClickBehavior||d.usePopupManager||(h=w.connect(f,"onClick",ka),m=ka));f.addLayers(a);d.ignorePopups||d.usePopupManager||Va(a,f,d._clazz);var p=l||[];k.forEach(e,function(a){a.errors&&(p=p.concat(a.errors))},this);f.loaded?g.callback({map:f,itemInfo:c,errors:p,clickEventHandle:h,clickEventListener:m}):
w.connect(f,"onLoad",function(){g.callback({map:f,itemInfo:c,errors:p,clickEventHandle:h,clickEventListener:m})})}function U(a,e,c,b,d){var g=[];k.forEach(d,function(a){n.isArray(a.layerObject)?k.forEach(a.layerObject,function(a){g.push(a)}):g.push(a.layerObject)});if("BingMapsAerial"===d[0].type||"BingMapsRoad"===d[0].type||"BingMapsHybrid"===d[0].type)var f=setInterval(function(){if(d[0].layerObject&&d[0].layerObject.loaded)clearInterval(f),Ya(a,e,c,b,d,g);else if(d[0].errors){clearInterval(f);
var h="";d[0].errors&&d[0].errors.length&&(h=" ("+d[0].errors[0].message+")");b.errback(Error(Y.arcgis.utils.baseLayerError+h))}},10);else if(!g[0]&&d[0].baseMapLayer){var h="";d[0].errors&&d[0].errors.length&&(h=" ("+d[0].errors[0].message+")");b.errback(Error(Y.arcgis.utils.baseLayerError+h))}else Ya(a,e,c,b,d,g)}function Ya(a,e,c,b,d,g){try{var f=c.mapOptions||{};c.mapOptions=f;var h=a.item,m=a.itemData;!f.backgroundColor&&m.background&&m.background.color&&null!=m.background.color[0]&&(f.backgroundColor=
cb.toDojoColor(m.background.color));g=k.filter(g,l.isDefined);if(h)if(h.extent&&h.extent.length)if(f.extent)A(g,d,a,e,c,b);else{var q=new G(h.extent[0][0],h.extent[0][1],h.extent[1][0],h.extent[1][1],new E({wkid:4326})),p=g[0].spatialReference;4326===p.wkid?(f.extent=q,A(g,d,a,e,c,b)):102100===p.wkid||102113===p.wkid||3857===p.wkid?(q.xmin=Math.max(q.xmin,-180),q.xmax=Math.min(q.xmax,180),q.ymin=Math.max(q.ymin,-89.99),q.ymax=Math.min(q.ymax,89.99),f.extent=eb.geographicToWebMercator(q),A(g,d,a,e,
c,b)):c.geometryServiceURL||M.defaults.geometryService?(c.geometryServiceURL?new hb(c.geometryServiceURL):M.defaults.geometryService).project([q],p,function(h){h=h[0];f.extent=f.extent||h;A(g,d,a,e,c,b)},function(){A(g,d,a,e,c,b)}):b.errback(Error(Y.arcgis.utils.geometryServiceError))}else A(g,d,a,e,c,b);else A(g,d,a,e,c,b)}catch(t){b.errback(t)}}function nb(a){var e=[];k.forEach(a.operationalLayers,function(a){a.featureCollection?e.push({featureCollection:a.featureCollection,visibility:a.visibility,
title:a.title}):a.layerObject&&e.push({layer:a.layerObject,visibility:a.visibility,title:a.title})});return e}function Za(a){var e=[],c=a.baseMap.baseMapLayers;a.operationalLayers&&(c=c.concat(a.operationalLayers));k.forEach(c,function(a){var b={};if(a.featureCollection&&"CSV"!==a.type)!0===a.featureCollection.showLegend&&k.forEach(a.featureCollection.layers,function(c){if(!1!==c.showLegend){var d=c.layerObject.renderer;b={layer:c.layerObject,title:a.title,defaultSymbol:d&&d.defaultSymbol&&d.defaultLabel?
!0:!1};1<a.featureCollection.layers.length&&(b.title+=" - "+c.layerDefinition.name);e.push(b)}});else if(a.baseMapLayer&&!0===a.showLegend&&a.layerObject||!a.baseMapLayer&&!1!==a.showLegend&&a.layerObject&&!(a.layerObject instanceof x&&a.layerObject.mode===x.MODE_SELECTION)){var c=a.layerObject.renderer,f=a.layerObject.declaredClass,c=!c||c&&c.defaultSymbol&&c.defaultLabel?!0:!1;if(10.1>a.layerObject.version&&("esri.layers.ArcGISDynamicMapServiceLayer"===f||"esri.layers.ArcGISTiledMapServiceLayer"===
f)||"esri.layers.ArcGISImageServiceLayer"===f)c=!0;b={layer:a.layerObject,title:a.title,defaultSymbol:c};a.layers&&(f=k.map(k.filter(a.layers,function(a){return!1===a.showLegend}),function(a){return a.id}),f.length&&(b.hideLayers=f));e.push(b)}});return e}function ob(a,e){function c(a,b){k.forEach(a,function(a,c){switch(a){case "../layers/ArcGISDynamicMapServiceLayer":sa=b[c];break;case "../layers/ArcGISImageServiceLayer":za=b[c];break;case "../layers/ArcGISImageServiceVectorLayer":ya=b[c];break;
case "./csv":Ja=b[c];break;case "../layers/CSVLayer":Ka=b[c];break;case "../layers/DynamicLayerInfo":ta=b[c];break;case "../layers/GeoRSSLayer":Ia=b[c];break;case "../layers/ImageParameters":ra=b[c];break;case "../layers/ImageServiceParameters":va=b[c];break;case "../layers/KMLLayer":Fa=b[c];break;case "../layers/LabelClass":Ma=b[c];break;case "../layers/LayerDrawingOptions":ua=b[c];break;case "../layers/MosaicRule":xa=b[c];break;case "../layers/OpenStreetMapLayer":Ba=b[c];break;case "../layers/RasterFunction":wa=
b[c];break;case "../layers/StreamLayer":Na=b[c];break;case "../layers/TileInfo":Ha=b[c];break;case "../layers/VectorTileLayer":Q=b[c];break;case "../virtualearth/VETiledLayer":z=b[c];break;case "../layers/WebTiledLayer":Ga=b[c];break;case "../layers/WFSLayer":Ca=b[c];break;case "../layers/WMSLayer":Ea=b[c];break;case "../layers/WMSLayerInfo":Da=b[c]}})}var b=new u,d=a.itemData,g=[];d.baseMap&&d.baseMap.baseMapLayers&&(g=g.concat(d.baseMap.baseMapLayers));d.operationalLayers&&(g=g.concat(d.operationalLayers));
for(var d=k.map(g,function(a){return a&&a.layerType}),f=[],h=[],g=!1,l=0;l<d.length;l++){switch(d[l]){case "ArcGISFeatureLayer":-1===k.indexOf(f,"../layers/LabelClass")&&f.push("../layers/LabelClass");break;case "ArcGISImageServiceLayer":case "ArcGISTiledImageServiceLayer":-1===k.indexOf(f,"../layers/ArcGISImageServiceLayer")&&(f.push("../layers/ArcGISImageServiceLayer"),h.push("../layers/ImageServiceParameters"),h.push("../layers/MosaicRule"),h.push("../layers/RasterFunction"));break;case "ArcGISImageServiceVectorLayer":-1===
k.indexOf(f,"../layers/ArcGISImageServiceVectorLayer")&&(f.push("../layers/ArcGISImageServiceVectorLayer"),h.push("../layers/ImageServiceParameters"),h.push("../layers/MosaicRule"),h.push("../layers/RasterFunction"));break;case "ArcGISMapServiceLayer":case "ArcGISTiledMapServiceLayer":-1===k.indexOf(f,"../layers/ArcGISDynamicMapServiceLayer")&&(f.push("../layers/ArcGISDynamicMapServiceLayer"),h.push("../layers/DynamicLayerInfo"),h.push("../layers/ImageParameters"),h.push("../layers/LayerDrawingOptions"));
break;case "ArcGISStreamLayer":-1===k.indexOf(f,"../layers/StreamLayer")&&f.push("../layers/StreamLayer");break;case "BingMapsAerial":case "BingMapsHybrid":case "BingMapsRoad":-1===k.indexOf(f,"../virtualearth/VETiledLayer")&&f.push("../virtualearth/VETiledLayer");break;case "CSV":-1===k.indexOf(f,"../layers/CSVLayer")&&(f.push("../layers/CSVLayer"),h.push("./csv"));break;case "GeoRSS":-1===k.indexOf(f,"../layers/GeoRSSLayer")&&f.push("../layers/GeoRSSLayer");break;case "KML":-1===k.indexOf(f,"../layers/KMLLayer")&&
f.push("../layers/KMLLayer");break;case "OpenStreetMap":-1===k.indexOf(f,"../layers/OpenStreetMapLayer")&&f.push("../layers/OpenStreetMapLayer");break;case "VectorTileLayer":-1===k.indexOf(f,"../layers/VectorTileLayer")&&f.push("../layers/VectorTileLayer");break;case "WebTiledLayer":-1===k.indexOf(f,"../layers/WebTiledLayer")&&(f.push("../layers/WebTiledLayer"),h.push("../layers/TileInfo"));break;case "WFS":-1===k.indexOf(f,"../layers/WFSLayer")&&f.push("../layers/WFSLayer");break;case "WMS":-1===
k.indexOf(f,"../layers/WMSLayer")&&(f.push("../layers/WMSLayer"),h.push("../layers/WMSLayerInfo"));break;default:g=!0}if(g)break}g&&(f=pb,h=qb);f.length?K(f,function(){c(f,arguments);h.length?K(h,function(){c(h,arguments);b.resolve()}):b.resolve()}):b.resolve();return b}function $a(a,e,c,b){var d=b.itemData;d.baseMap&&d.baseMap.baseMapLayers&&d.baseMap.baseMapLayers.length&&(d.baseMap.baseMapLayers[0].firstLayer=!0);var g=e.layerMixins,f=g&&g.length;if(f){var h=function(a){for(var b=0;b<f;b++){var c=
g[b];if(c.mixin)if(c.hasOwnProperty("id")){if(a.id===c.id){n.mixin(a,c.mixin);break}}else if(a.url===c.url){n.mixin(a,c.mixin);break}}};k.forEach(d.baseMap&&d.baseMap.baseMapLayers,h);k.forEach(d.operationalLayers,h)}ob(b,e).then(function(){return kb(b,e)}).then(function(){return jb(b,e)}).then(function(b){var d=b[0],e=b[1];if(d.itemData.operationalLayers&&0!==d.itemData.operationalLayers.length){var f=new u,g=d.itemData.baseMap.baseMapLayers.slice(),h=k.filter(d.itemData.baseMap.baseMapLayers,function(a){return!a.isReference});
b={item:d.item,itemData:{baseMap:{baseMapLayers:h}}};d.itemData.baseMap.baseMapLayers=k.filter(d.itemData.baseMap.baseMapLayers,function(a){return a.isReference});N(b,e).addCallback(function(b){R(b.itemData,e).addCallback(n.hitch(null,U,b,a,e,f))});f.then(function(a){N(d,e).addCallback(function(b){R(b.itemData,e,a.map.spatialReference,h,a.map).addCallback(function(d){b.itemData.baseMap.baseMapLayers=g;U(b,a,e,c,d)})})},n.hitch(c,c.errback))}else N(d,e).addCallback(function(b){R(b.itemData,e).addCallback(n.hitch(null,
U,b,a,e,c))})})}function ca(a,e){"undefined"===typeof e&&(e=!0);r._arcgisUrl&&0<r._arcgisUrl.length&&(r.arcgisUrl=r._arcgisUrl);var c=r.arcgisUrl+"/"+a,b={},d=new u;D({url:c,content:{f:"json"},callbackParamName:"callback",load:function(a){b.item=a;e?D({url:c+"/data",content:{f:"json"},callbackParamName:"callback",load:function(a){b.itemData=a;d.callback(b)},error:function(a){d.errback(a)}}):d.callback(b)},error:function(a){d.errback(a)}});return d}var r,sa,za,ya,Ja,Ka,ta,Ia,ra,va,Fa,Ma,ua,xa,Ba,wa,
Na,Ha,Q,z,Ga,Ca,Ea,Da,pb="../layers/ArcGISDynamicMapServiceLayer ../layers/ArcGISImageServiceLayer ../layers/ArcGISImageServiceVectorLayer ../layers/CSVLayer ../layers/GeoRSSLayer ../layers/KMLLayer ../layers/LabelClass ../layers/OpenStreetMapLayer ../layers/StreamLayer ../layers/VectorTileLayer ../virtualearth/VETiledLayer ../layers/WebTiledLayer ../layers/WFSLayer ../layers/WMSLayer".split(" "),qb="./csv ../layers/DynamicLayerInfo ../layers/ImageParameters ../layers/ImageServiceParameters ../layers/LayerDrawingOptions ../layers/MosaicRule ../layers/RasterFunction ../layers/TileInfo ../layers/WMSLayerInfo".split(" ");
r={arcgisUrl:W.getProtocolForWebResource()+"//www.arcgis.com/sharing/rest/content/items",getItem:ca,createMap:function(a,e,c){var b=new u;c=c||{};var d=c.infoTemplateClass;c._clazz=d&&(n.isObject(d)?d:n.getObject(d))||X;n.isString(a)?ca(a).addCallback(n.hitch(null,$a,e,c,b)).addErrback(n.hitch(b,b.errback)):$a(e,c,b,a);return b},getLayerList:function(a){return a&&a.itemInfo&&a.itemInfo.itemData?nb(a.itemInfo.itemData):[]},getLegendLayers:function(a){return a&&a.itemInfo&&a.itemInfo.itemData?Za(a.itemInfo.itemData):
[]},_arcgisUrl:null,_getItemProps:N,_getItemData:I,_getBingKey:Z,_portalUrlResponse:ba,_portalUrlFailure:O,_processFSItemProperties:aa,_processSSItemProperties:na,_getLayers:R,_preBuildLayerObjects:Oa,_buildLayerObjects:ia,_preCreateMap:U,_getMapSR:ja,_createMap:A,_addSelectionLayers:Va,_createSelectionFeatureLayers:T,_getServiceInfo:Pa,_getFeatureCollectionItem:Qa,_mergeFeatureCollectionItem:Ra,_projectFeatureCollection:Sa,_getLayersInfo:Ua,_initLayer:Aa,_loadAsCached:ea,_loadAsDynamic:qa,_processPopups:da,
_onLayersAddResult:Wa,_sameSpatialReferenceAsBasemap:ga,_sameTilingSchemeAsBasemap:ha,_showPopup:ka,_calculateClickTolerance:Xa,_getVisibleFeatureLayers:fa,_updateLayerScaleInfo:S,_checkUrl:B,_isHostedService:oa,_isAgolService:pa,_getLegendLayers:Za};n.setObject("arcgis.utils",r,C);return r});