// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.24/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/layers/support/Tilemap","require exports dojo/_base/lang ../../request ../../core/Error ../../core/lang ../../core/promiseUtils".split(" "),function(l,h,n,p,f,q,r){function m(a){var b;"vector-tile"===a.service.type?b=a.service.url+"/tilemap/"+a.level+"/"+a.row+"/"+a.col+"/"+a.width+"/"+a.height:(b=a.service.tileServers,b=(b&&b.length?b[a.row%b.length]:a.service.url)+"/tilemap/"+a.level+"/"+a.row+"/"+a.col+"/"+a.width+"/"+a.height);(a=a.service.query)&&(b=b+"?"+a);return b}
Object.defineProperty(h,"__esModule",{value:!0});l=function(){function a(){this.location={left:0,top:0,width:0,height:0};this.byteSize=40}a.prototype.getAvailability=function(b,a){if(this._isAllAvailable)return"available";if(this._isAllUnvailable)return"unavailable";var c=(b-this.location.top)*this.location.width+(a-this.location.left),d=c>>3,e=this._tileAvailabilityBitSet;return 0>d||d>e.length?"unknown":e[d]&1<<c%8?"available":"unavailable"};a.prototype._updateFromData=function(a){for(var b=!0,
f=!0,d=new Uint8Array(Math.ceil(this.location.width*this.location.height/8)),e=0,g=0;g<a.length;g++){var k=g%8;a[g]?(f=!1,d[e]|=1<<k):b=!1;7===k&&++e}this._isAllUnvailable=f;this._isAllAvailable=b;this._isAllAvailable||this._isAllUnvailable||(this._tileAvailabilityBitSet=d,this.byteSize+=d.length)};a.fromDefinition=function(b,c){var h=b.service.request||p,d=b.row,e=b.col,g=b.width,k=b.height,l={callbackParamName:"callback"};c=c?n.mixin(l,c):l;return h(m(b),c).then(function(a){return a.data}).catch(function(a){if(a&&
a.details&&422===a.details.httpStatus){a=[];for(var b=0,c=g*k;b<c;b++)a[b]=0;return{location:{top:d,left:e,width:g,height:k},valid:!0,data:a}}return r.reject(a)}).then(function(b){if(b.location&&(b.location.top!==d||b.location.left!==e||b.location.width!==g||b.location.height!==k))throw new f("tilemap:location-mismatch","Tilemap response for different location than requested",{response:b,definition:{top:d,left:e,width:g,height:k}});return a.fromJSON(b)})};a.fromJSON=function(b){a.validateJSON(b);
var c=new a;c.location=Object.freeze(q.clone(b.location));c._updateFromData(b.data);return Object.freeze(c)};a.validateJSON=function(a){if(!a||!a.location)throw new f("tilemap:missing-location","Location missing from tilemap response");if(!1===a.valid)throw new f("tilemap:invalid","Tilemap response was marked as invalid");if(!a.data)throw new f("tilemap:missing-data","Data missing from tilemap response");if(!Array.isArray(a.data))throw new f("tilemap:data-mismatch","Data must be an array of numbers");
if(a.data.length!==a.location.width*a.location.height)throw new f("tilemap:data-mismatch","Number of data items does not match width/height of tilemap");};return a}();h.Tilemap=l;h.tilemapDefinitionId=function(a){return a.level+"/"+a.row+"/"+a.col+"/"+a.width+"/"+a.height};h.tilemapDefinitionUrl=m;h.default=l});