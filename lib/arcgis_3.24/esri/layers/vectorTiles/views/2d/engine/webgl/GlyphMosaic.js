// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.24/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/2d/engine/webgl/GlyphMosaic","require exports dojo/has dojo/promise/all ./fontUtils ./Rect ./RectangleBinPack ../../../webgl/Texture".split(" "),function(H,I,v,E,F,G,D,n){var r;v("stable-symbol-rendering")&&(r=new Set);return function(){function g(c,b,a){this.height=this.width=0;this._dirties=[];this._glyphData=[];this._currentPage=0;this._glyphIndex={};this._textures=[];this._rangePromises=new Map;(0>=c||0>=b)&&console.error("Glyph mosaic width and height must be greater than zero!");
this.width=c;this.height=b;this._glyphSource=a;this._binPack=new D(c-4,b-4);this._glyphData.push(new Uint8Array(c*b));this._dirties.push(!0);this._textures.push(void 0)}g.prototype.getGlyphItems=function(c,b){for(var a=this,t=F.getFullyQualifiedFontName(c),k=[],g=this._glyphSource,A=new Set,n=1/256,B=0;B<b.length;B++)A.add(Math.floor(b[B]*n));var C=[];A.forEach(function(b){if(256>=b){var d=t+b;a._rangePromises.has(d)?C.push(a._rangePromises.get(d)):(b=g.getRange(t,b).always(function(){a._rangePromises["delete"](d)}),
a._rangePromises.set(d,b),C.push(b))}});return E(C).then(function(c){c=a._glyphIndex[t];c||(c={},a._glyphIndex[t]=c);var d;if(v("stable-symbol-rendering")){r.clear();for(var f=0;f<b.length;f++)d=b[f],r.add(d);var w=[];A.forEach(function(a){w.push(a)});w.sort();d=[];for(f=0;f<w.length;f++)for(var x=w[f],e=0;256>e;++e)d.push(256*x+e)}else d=b;f=0;for(x=d;f<x.length;f++)if(d=x[f],e=c[d]){if(!v("stable-symbol-rendering")||r.has(d))k[d]={rect:e.rect,metrics:e.metrics,page:e.page}}else{var l=g.getGlyph(t,
d);if(l&&l.metrics){var e=l.metrics,h=void 0;if(0===e.width)h=new G(0,0,0,0);else{var p=e.width+6,u=e.height+6,q=p%4?4-p%4:4,m=u%4?4-u%4:4;1===q&&(q=5);1===m&&(m=5);h=a._binPack.allocate(p+q,u+m);h.isEmpty&&(a._dirties[a._currentPage]||(a._glyphData[a._currentPage]=null),a._currentPage=a._glyphData.length,a._glyphData.push(new Uint8Array(a.width*a.height)),a._dirties.push(!0),a._textures.push(void 0),a._binPack=new D(a.width-4,a.height-4),h=a._binPack.allocate(p+q,u+m));var q=a._glyphData[a._currentPage],
l=l.bitmap,n=m=void 0;if(l)for(var y=0;y<u;y++)for(var m=p*y,n=a.width*(h.y+y+1)+h.x,z=0;z<p;z++)q[n+z+1]=l[m+z]}c[d]={rect:h,metrics:e,tileIDs:null,page:a._currentPage};if(!v("stable-symbol-rendering")||r.has(d))k[d]={rect:h,metrics:e,page:a._currentPage};a._dirties[a._currentPage]=!0}}return k})};g.prototype.bind=function(c,b,a,g){this._textures[a]||(this._textures[a]=new n(c,{pixelFormat:6406,dataType:5121,width:this.width,height:this.height},new Uint8Array(this.width*this.height)));var k=this._textures[a];
k.setSamplingMode(b);this._dirties[a]&&k.setData(this._glyphData[a]);c.bindTexture(k,g);this._dirties[a]=!1};g.prototype.dispose=function(){this._binPack=null;for(var c=0,b=this._textures;c<b.length;c++){var a=b[c];a&&a.dispose()}this._textures.length=0};return g}()});