// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.24/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/core/conversion/portalToEditorUtils/MetadataParser",["esri/dijit/geoenrichment/utils/JsonXmlConverter","./variables/VariableUtil","../../../_devConfig"],function(b,k,m){var l={},h={getObjects:function(b,e){var a=h._getVariableInfo(b,e),c=h._getScriptObjects(b);return{variables:a.variables,variableObjects:a.variableObjects,scriptObjects:c}},_getVariableInfo:function(g,e){var a=[];b.queryJson(g,e?/RawFields|Fields/:"Fields").forEach(function(n){a=a.concat(b.queryJson(n,
/Field|PortalFiel/))});var c=[],d=[];a.forEach(function(a){c.push(a.attributes.MapTo);(a=k.fieldTagToVariable(a,g.attributes.Name))&&d.push(a)});return{variables:c,variableObjects:d}},_getScriptObjects:function(g){var e=b.queryJson(g,"CalculatedFields")[0];return(e&&b.queryJson(e,"Script")||[]).map(function(a){return k.scriptTagToVariable(a,g.attributes.Name)})}};l.parseMetadataXML=function(g,e,a){a.log&&a.log(g.data);var c=b.parseXml(g.data);c&&c.tags&&(function(){b.queryJson(c,"SpecialTradeAreaFields").forEach(function(b){a.variableProvider.isDummy&&
h.getObjects(b,!0).variableObjects.forEach(function(b){a.variableProvider.addVariable(b)})})}(),function(){b.queryJson(c,"DataCollections").forEach(function(d){var c=b.queryJson(d,"ComparisonLevel");if(m.emulateErrors.metadataParseError)throw Error("Error test: something crashed during the parsing of the metadata!");var f;if(a.variableProvider.isDummy||c.length)f=h.getObjects(d);c.length&&(d={calculatorName:d.attributes.Name,levels:c.map(function(a){return a.attributes.Name}),variableObjects:f.variableObjects},
e&&(e.metadata.comparisonCalculatorsHash[d.calculatorName]=d));a.variableProvider.isDummy&&(f.variableObjects.forEach(function(b){a.variableProvider.addVariable(b)}),f.scriptObjects.forEach(function(b){a.variableProvider.addScriptVariable(b)}))})}(),function(){b.queryJson(c,"Maps").forEach(function(a){b.queryJson(a,"Map").forEach(function(c){var f=b.queryJson(c,"Layer").filter(function(a){return!!a.attributes.PortalItemId}),d;1<f.length&&(d=f.shift());f=f.shift();d={defaultBasemapId:d&&d.attributes.PortalItemId,
webMapId:f&&f.attributes.PortalItemId,mapScale:Number(c.attributes.Scale)||null,fieldName:c.attributes.Name};e&&(e.metadata.mapImageInfosHash[a.attributes.Name+"."+c.attributes.Name]=d)})})}())};return l});