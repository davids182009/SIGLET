//>>built
define("dstore/Trackable","dojo/_base/lang dojo/_base/declare dojo/aspect dojo/when dojo/promise/all dojo/_base/array dojo/on".split(" "),function(D,z,H,B,p,E,I){function F(h,l,u){for(var r=h.length-1;0<=r;--r){var n=h[r],y=n.start,n=y+n.count;if(l>n){h.splice(r+1,0,{start:l,count:u-l});return}u>=y&&(l=Math.min(l,y),u=Math.max(u,n),h.splice(r,1))}h.unshift({start:l,count:u-l})}var J=0,C={track:function(){function h(){return function(){var c=this,a=this.inherited(arguments);B(a,function(a){a=c._results=
a.slice();c._partialResults&&(c._partialResults=null);c._ranges=[];F(c._ranges,0,a.length)});return a}}function l(){return function(c){var a=this,d=c.start,f=c.end,g=this.inherited(arguments);this._results||B(g,function(b){return B(b.totalLength,function(c){var e=a._partialResults||(a._partialResults=[]);f=Math.min(f,d+b.length);e.length=c;c=[d,f-d].concat(b);e.splice.apply(e,c);F(a._ranges,d,f);return b})});return g}}function u(c,a){J++;var d=a.target;a=D.delegate(a,C[c]);var f=a.beforeId;B(t._results||
t._partialResults,function(g){if(g){var b,e,h,m=t._ranges,k,l="id"in a?a.id:r.getIdentity(d),n=-1,v=-1,q=-1,w=-1,p;if("delete"===c||"update"===c)for(b=0;-1===n&&b<m.length;++b)for(k=m[b],e=k.start,h=e+k.count;e<h;++e)if(r.getIdentity(g[e])==l){n=a.previousIndex=e;v=b;p=f==l;g.splice(n,1);k.count--;for(e=b+1;e<m.length;++e)m[e].start--;break}if("add"===c||"update"===c){if(A){if(A([d]).length){var x=0;h=m.length-1;for(p=-1;x<=h&&-1===q;)b=x+Math.round((h-x)/2),k=m[b],v=g.slice(k.start,k.start+k.count),
void 0!==f&&(p=null===f?v.length:G(v,f)),-1===p&&(p=n>=Math.max(0,k.start-1)&&n<=k.start+k.count?n:r.defaultNewToStart?0:v.length),v.splice(p,0,d),e=E.indexOf(A(v),d),l=k.start+e,0===e&&0!==k.start?h=b-1:e>=v.length-1&&l<g.length?x=b+1:(q=l,w=b);if(-1===q&&0<x&&x<m.length)var u=!0}}else{e=-1;if(void 0===f||p)"update"===c?(q=n,w=v):r.defaultNewToStart?e=q=0:(q=g.length,e=m.length-1);else if(null===f)q=g.length,e=m.length-1;else for(b=0,h=m.length;-1===w&&b<h;++b)k=m[b],q=G(g,f,k.start,k.start+k.count),
-1!==q&&(w=b);-1!==e&&-1===w&&(k=m[e])&&k.start<=q&&q<=k.start+k.count&&(w=e)}if(-1<q&&-1<w)for(a.index=q,g.splice(q,0,d),m[w].count++,b=w+1;b<m.length;++b)m[b].start++;else if(u)for(a.beforeIndex=m[x].start,b=x;b<m.length;++b)m[b].start++}a.totalLength=g.length}(g=t["on_tracked"+c])&&g.call(t,a)})}var r=this.store||this,n=[],y={add:1,update:1,"delete":1},p;for(p in y)n.push(this.on(p,function(c){return function(a){u(c,a)}}(p)));var t=z.safeMixin(D.delegate(this),{_ranges:[],fetch:h(),fetchRange:l(),
releaseRange:function(c,a){if(this._partialResults){a:for(var d=this._ranges,f=0,g;g=d[f];++f){var b=g.start,e=b+g.count;if(c<=b)if(a>=e)d.splice(f,1);else{g.start=a;g.count=e-g.start;break a}else if(c<e)if(a>b){d.splice(f,1,{start:b,count:c-b},{start:a,count:e-a});break a}else g.count=c-g.start}for(d=c;d<a;++d)delete this._partialResults[d]}},on:function(c,a){var d=this,f=this.getInherited(arguments);return I.parse(t,c,a,function(c,b){return b in y?H.after(t,"on_tracked"+b,a,!0):f.call(d,b,a)})},
tracking:{remove:function(){for(;0<n.length;)n.pop().remove();this.remove=function(){}}},track:null});this.fetchSync&&(z.safeMixin(t,{fetchSync:h(),fetchRangeSync:l()}),t.fetchSync());var A;E.forEach(this.queryLog,function(c){var a=A,d=c.querier;d&&(A=a?function(c){return d(a(c))}:d)});var C={add:{index:void 0},update:{previousIndex:void 0,index:void 0},"delete":{previousIndex:void 0}},G=function(c,a,d,f){f=void 0!==f?f:c.length;for(d=void 0!==d?d:0;d<f;++d)if(r.getIdentity(c[d])===a)return d;return-1};
return t}};p=z(null,C);p.create=function(h,l){h=z.safeMixin(D.delegate(h),C);z.safeMixin(h,l);return h};return p});